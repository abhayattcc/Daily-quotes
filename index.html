<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kids' Quote Quest</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Comic Neue', cursive;
      background: #f0f4f8;
      margin: 0;
      min-height: 100vh;
      position: relative;
      touch-action: manipulation;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
      position: relative;
      z-index: 10;
    }
    .progress-container {
      width: 100%;
      max-width: 600px;
      background: #ffffff;
      border: 4px solid #ffca28;
      border-radius: 15px;
      margin: 1rem auto;
      display: none;
    }
    .progress-bar {
      height: 30px;
      background: #4caf50;
      border-radius: 10px;
      text-align: center;
      color: white;
      font-size: 1.2rem;
      line-height: 30px;
    }
    .quote-card {
      background: #ffffff;
      border: 4px solid #ffca28;
      border-radius: 15px;
      padding: 1rem;
      margin-bottom: 1rem;
      position: relative;
      overflow: hidden;
    }
    .quote-card::before {
      content: '✨';
      position: absolute;
      top: -10px;
      right: -10px;
      font-size: 2rem;
      opacity: 0.3;
    }
    .select-box {
      background: #ffffff;
      border: 4px solid #ffca28;
      border-radius: 10px;
      padding: 0.5rem;
      font-size: 1.2rem;
      color: #333;
      cursor: pointer;
      width: 100%;
      transition: transform 0.2s ease;
    }
    .select-box:hover {
      transform: scale(1.05);
    }
    .title {
      color: #e91e63;
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .loading-text, .error-text, .no-quotes-text {
      color: #e91e63;
      text-align: center;
      font-size: 1.2rem;
    }
    .quote-text {
      color: #d81b60;
      line-height: 1.5;
      font-weight: bold;
      background: #fffde7;
      padding: 0.5rem;
      border-radius: 10px;
    }
    .author-text {
      color: #1976d2;
      font-weight: bold;
    }
    .category-text {
      color: #7b1fa2;
    }
    .toggle-button {
      background: #4caf50;
      border: 3px solid #ffca28;
      border-radius: 50%;
      padding: 0.75rem;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .toggle-button:hover {
      transform: scale(1.1);
    }
    .nav-button {
      background: #2196f3;
      border: 3px solid #ffca28;
      border-radius: 10px;
      padding: 0.5rem 1rem;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .nav-button:hover {
      transform: scale(1.05);
    }
    .nav-button:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
    }
    @media (max-width: 768px) {
      .title {
        font-size: 2rem;
      }
      .select-box {
        font-size: 1rem;
        padding: 0.4rem;
      }
      .quote-text {
        font-size: 1.2rem;
      }
      .author-text {
        font-size: 1rem;
      }
      .category-text {
        font-size: 0.9rem;
      }
      .progress-bar {
        font-size: 1rem;
        height: 25px;
        line-height: 25px;
      }
      .quote-card {
        padding: 0.8rem;
      }
      .nav-button {
        font-size: 1rem;
        padding: 0.4rem;
      }
      .toggle-button {
        font-size: 1.2rem;
        padding: 0.5rem;
      }
    }
    @media (min-width: 769px) {
      .title {
        font-size: 3rem;
      }
      .select-box {
        font-size: 1.3rem;
      }
      .quote-text {
        font-size: 1.5rem;
      }
      .author-text {
        font-size: 1.2rem;
      }
      .category-text {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title text-2xl md:text-4xl font-bold">
      Kids' Quote Adventure 🌟
    </h1>

    <div id="progressContainer" class="progress-container">
      <div id="progressBar" class="progress-bar">0%</div>
    </div>

    <div class="flex flex-col md:flex-row gap-3 md:gap-4 mb-6 justify-center flex-wrap">
      <select id="databaseSelect" class="select-box">
        <option value="en.db">English Quotes</option>
        <option value="quote.db">Odia Quotes</option>
      </select>
      <select id="modeSelect" class="select-box">
        <option value="daily">Daily Quote</option>
        <option value="all">All Quotes</option>
      </select>
      <select id="categoryFilter" class="select-box hidden">
        <option value="">All Themes</option>
      </select>
      <select id="authorFilter" class="select-box hidden">
        <option value="">All Heroes</option>
      </select>
    </div>

    <div id="quoteContainer" class="grid gap-4">
      <p class="loading-text text-lg md:text-xl">Loading fun quotes... 🎉</p>
    </div>

    <div id="navButtons" class="flex justify-between mt-4 hidden">
      <button id="prevButton" class="nav-button">Back</button>
      <button id="nextButton" class="nav-button">Next</button>
    </div>
  </div>

  <script>
    if ('serviceWorker' in navigator) {
      const swContent = `
        const CACHE_NAME = 'quote-app-v11';
        const urlsToCache = [
          '/',
          'https://cdn.tailwindcss.com',
          'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.wasm',
          'https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap',
          'https://raw.githubusercontent.com/abhayattcc/Daily-quotes/refs/heads/main/en.db',
          'https://raw.githubusercontent.com/abhayattcc/Daily-quotes/refs/heads/main/quote.db'
        ];

        self.addEventListener('install', event => {
          event.waitUntil(
            caches.open(CACHE_NAME).then(cache => {
              return cache.addAll(urlsToCache).then(() => self.skipWaiting());
            })
          );
        });

        self.addEventListener('fetch', event => {
          event.respondWith(
            caches.match(event.request).then(response => {
              if (response) {
                return response;
              }
              return fetch(event.request).then(fetchResponse => {
                if (!fetchResponse || fetchResponse.status !== 200) {
                  return fetchResponse;
                }
                return caches.open(CACHE_NAME).then(cache => {
                  cache.put(event.request, fetchResponse.clone());
                  return fetchResponse;
                });
              }).catch(() => {
                return caches.match('/').then(response => {
                  if (response) return response;
                  return new Response('Offline mode: Please connect to the internet for first load.', { status: 503 });
                });
              });
            })
          );
        });

        self.addEventListener('activate', event => {
          event.waitUntil(
            caches.keys().then(cacheNames => {
              return Promise.all(
                cacheNames.filter(name => name !== CACHE_NAME)
                  .map(name => caches.delete(name))
              );
            }).then(() => self.clients.claim())
          );
        });
      `;
      const blob = new Blob([swContent], { type: 'application/javascript' });
      const swURL = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swURL);
    }

    let db;
    let currentDbName = 'en.db';
    const databases = ['en.db', 'quote.db'];
    const isTTSSupported = 'speechSynthesis' in window;
    let defaultOdiaVoice = null;
    let currentUtterance = null;
    let activeUtterances = 0;
    let quotes = [];
    let currentPage = 0;

    function initializeVoices() {
      if (isTTSSupported && currentDbName === 'quote.db') {
        const voices = window.speechSynthesis.getVoices();
        defaultOdiaVoice = voices.find(v => v.lang.startsWith('or') && v.name.includes('Google')) || voices.find(v => v.lang.startsWith('or'));
      }
    }

    if (isTTSSupported) {
      window.speechSynthesis.onvoiceschanged = initializeVoices;
      initializeVoices();
    }

    function showProgressBar(percentage) {
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      progressContainer.style.display = 'block';
      progressBar.style.width = `${percentage}%`;
      progressBar.textContent = `${Math.round(percentage)}%`;
      if (percentage >= 100) {
        setTimeout(() => {
          progressContainer.style.display = 'none';
        }, 500);
      }
    }

    async function initDb(dbName) {
      try {
        showProgressBar(0);
        const SQL = await initSqlJs({ 
          locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`,
          cache: 'force-cache' 
        });
        showProgressBar(20);

        const totalSteps = databases.length + 2;
        let currentStep = 1;

        for (const dbFile of databases) {
          const cache = await caches.open('quote-app-v11');
          const cachedResponse = await cache.match(`https://raw.githubusercontent.com/abhayattcc/Daily-quotes/refs/heads/main/${dbFile}`);
          let arrayBuffer;
          
          if (cachedResponse) {
            arrayBuffer = await cachedResponse.arrayBuffer();
          } else {
            const response = await fetch(`https://raw.githubusercontent.com/abhayattcc/Daily-quotes/refs/heads/main/${dbFile}`, { cache: 'force-cache' });
            arrayBuffer = await response.arrayBuffer();
            await cache.put(`https://raw.githubusercontent.com/abhayattcc/Daily-quotes/refs/heads/main/${dbFile}`, new Response(arrayBuffer));
          }

          if (dbFile === dbName) {
            db = new SQL.Database(new Uint8Array(arrayBuffer));
          }
          currentStep++;
          showProgressBar((currentStep / totalSteps) * 100);
        }

        updateUI();
        showProgressBar(100);
      } catch (error) {
        console.error('Error initializing database:', error);
        document.getElementById('quoteContainer').innerHTML = '<p class="error-text text-lg md:text-xl">Oops! Something went wrong. Try again! 😊</p>';
        showProgressBar(0);
      }
    }

    function populateFilters() {
      const categoryStmt = db.prepare('SELECT DISTINCT category_name FROM quote ORDER BY category_name');
      const categories = [];
      while (categoryStmt.step()) {
        categories.push(categoryStmt.getAsObject().category_name);
      }
      categoryStmt.free();

      const authorStmt = db.prepare('SELECT DISTINCT author_name FROM quote ORDER BY author_name');
      const authors = [];
      while (authorStmt.step()) {
        authors.push(authorStmt.getAsObject().author_name);
      }
      authorStmt.free();

      const categorySelect = document.getElementById('categoryFilter');
      const authorSelect = document.getElementById('authorFilter');
      categorySelect.innerHTML = '<option value="">All Themes</option>';
      authorSelect.innerHTML = '<option value="">All Heroes</option>';

      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
      });

      authors.forEach(author => {
        const option = document.createElement('option');
        option.value = author;
        option.textContent = author;
        authorSelect.appendChild(option);
      });
    }

    function getCurrentDate() {
      const today = new Date();
      return today.toISOString().split('T')[0];
    }

    function toggleSpeech(quoteText, button) {
      if (!isTTSSupported || currentDbName !== 'quote.db') return;

      if (currentUtterance && window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
        currentUtterance = null;
        activeUtterances = 0;
        button.textContent = '🔊 Play';
        button.style.background = '#4caf50';
      } else if (defaultOdiaVoice) {
        currentUtterance = new SpeechSynthesisUtterance(quoteText);
        currentUtterance.voice = defaultOdiaVoice;
        currentUtterance.lang = defaultOdiaVoice.lang;
        currentUtterance.rate = 0.7;
        currentUtterance.pitch = 1.0;
        currentUtterance.volume = 4.0;
        currentUtterance.onend = () => {
          activeUtterances--;
          if (activeUtterances === 0) {
            button.textContent = '🔊 Play';
            button.style.background = '#4caf50';
            currentUtterance = null;
          }
        };
        activeUtterances++;
        window.speechSynthesis.speak(currentUtterance);
        button.textContent = '⏹ Stop';
        button.style.background = '#1976d2';
      }
    }

    function displayDailyQuote() {
      const today = getCurrentDate();
      const storageKey = `dailyQuote_${currentDbName}`;
      const storedQuote = localStorage.getItem(storageKey);
      const storedDate = localStorage.getItem(`quoteDate_${currentDbName}`);

      if (storedQuote && storedDate === today) {
        const quote = JSON.parse(storedQuote);
        displayQuote(quote);
        return;
      }

      const stmt = db.prepare('SELECT author_name, category_name, qte FROM quote ORDER BY RANDOM() LIMIT 1');
      let quote = null;
      if (stmt.step()) {
        quote = stmt.getAsObject();
      }
      stmt.free();

      if (quote) {
        localStorage.setItem(storageKey, JSON.stringify(quote));
        localStorage.setItem(`quoteDate_${currentDbName}`, today);
        displayQuote(quote);
      } else {
        document.getElementById('quoteContainer').innerHTML = '<p class="no-quotes-text text-lg md:text-xl">No quotes today, check back tomorrow! 😊</p>';
        document.getElementById('navButtons').classList.add('hidden');
      }
    }

    function displayPagedQuote() {
      const container = document.getElementById('quoteContainer');
      const navButtons = document.getElementById('navButtons');
      const prevButton = document.getElementById('prevButton');
      const nextButton = document.getElementById('nextButton');

      if (quotes.length === 0) {
        container.innerHTML = '<p class="no-quotes-text text-lg md:text-xl">No quotes found, try another theme! 🌈</p>';
        navButtons.classList.add('hidden');
        return;
      }

      const quote = quotes[currentPage];
      const escapedQuote = quote.qte.replace(/'/g, "\\'");
      container.innerHTML = `
        <div class="quote-card">
          <p class="quote-text italic mb-3">"${quote.qte}"</p>
          <p class="author-text">— ${quote.author_name}</p>
          <p class="category-text">${quote.category_name}</p>
          ${isTTSSupported && currentDbName === 'quote.db' ? `<button class="toggle-button mt-3" onclick="toggleSpeech('${escapedQuote}', this)">🔊 Play</button>` : ''}
        </div>
      `;
      navButtons.classList.remove('hidden');
      prevButton.disabled = currentPage === 0;
      nextButton.disabled = currentPage === quotes.length - 1;
    }

    function displayAllQuotes() {
      const category = document.getElementById('categoryFilter').value;
      const author = document.getElementById('authorFilter').value;

      let query = 'SELECT author_name, category_name, qte FROM quote';
      const conditions = [];
      const params = [];

      if (category) {
        conditions.push('category_name = ?');
        params.push(category);
      }
      if (author) {
        conditions.push('author_name = ?');
        params.push(author);
      }
      if (conditions.length > 0) {
        query += ' WHERE ' + conditions.join(' AND ');
      }

      const stmt = db.prepare(query);
      if (params.length > 0) {
        stmt.bind(params);
      }

      quotes = [];
      while (stmt.step()) {
        quotes.push(stmt.getAsObject());
      }
      stmt.free();

      currentPage = 0;
      displayPagedQuote();
    }

    function displayQuote(quote) {
      const container = document.getElementById('quoteContainer');
      const escapedQuote = quote.qte.replace(/'/g, "\\'");
      container.innerHTML = `
        <div class="quote-card">
          <p class="quote-text italic mb-3">"${quote.qte}"</p>
          <p class="author-text">— ${quote.author_name}</p>
          <p class="category-text">${quote.category_name}</p>
          ${isTTSSupported && currentDbName === 'quote.db' ? `<button class="toggle-button mt-3" onclick="toggleSpeech('${escapedQuote}', this)">🔊 Play</button>` : ''}
        </div>
      `;
      document.getElementById('navButtons').classList.add('hidden');
    }

    function updateUI() {
      const mode = document.getElementById('modeSelect').value;
      const categoryFilter = document.getElementById('categoryFilter');
      const authorFilter = document.getElementById('authorFilter');

      if (mode === 'daily') {
        categoryFilter.classList.add('hidden');
        authorFilter.classList.add('hidden');
        displayDailyQuote();
      } else {
        categoryFilter.classList.remove('hidden');
        authorFilter.classList.remove('hidden');
        populateFilters();
        displayAllQuotes();
      }
    }

    function showNextQuote() {
      if (currentPage < quotes.length - 1) {
        currentPage++;
        displayPagedQuote();
      }
    }

    function showPrevQuote() {
      if (currentPage > 0) {
        currentPage--;
        displayPagedQuote();
      }
    }

    let touchStartX = 0;
    let touchEndX = 0;

    document.getElementById('quoteContainer').addEventListener('touchstart', e => {
      touchStartX = e.changedTouches[0].screenX;
    });

    document.getElementById('quoteContainer').addEventListener('touchend', e => {
      touchEndX = e.changedTouches[0].screenX;
      const mode = document.getElementById('modeSelect').value;
      if (mode === 'all') {
        if (touchEndX < touchStartX - 50) {
          showNextQuote();
        } else if (touchEndX > touchStartX + 50) {
          showPrevQuote();
        }
      }
    });

    document.getElementById('databaseSelect').addEventListener('change', (e) => {
      if (currentUtterance && window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
        currentUtterance = null;
        activeUtterances = 0;
      }
      currentDbName = e.target.value;
      initializeVoices();
      initDb(currentDbName);
    });
    document.getElementById('modeSelect').addEventListener('change', () => {
      if (currentUtterance && window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
        currentUtterance = null;
        activeUtterances = 0;
      }
      updateUI();
    });
    document.getElementById('categoryFilter').addEventListener('change', loadQuotes);
    document.getElementById('authorFilter').addEventListener('change', loadQuotes);
    document.getElementById('prevButton').addEventListener('click', showPrevQuote);
    document.getElementById('nextButton').addEventListener('click', showNextQuote);

    function loadQuotes() {
      const mode = document.getElementById('modeSelect').value;
      if (mode === 'daily') {
        displayDailyQuote();
      } else {
        displayAllQuotes();
      }
    }

    initDb(currentDbName);
  </script>
</body>
</html>